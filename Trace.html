<!DOCTYPE html>
<html>
  <head>
    <style>
      body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 8px; background: #f1f3f4; overflow: hidden; display: flex; flex-direction: column; height: calc(100vh - 16px); box-sizing: border-box; }
      #mode-indicator { font-size: 9px; font-weight: bold; color: #1a73e8; margin-bottom: 3px; letter-spacing: 1px; flex-shrink: 0; }
      #formula-box { background: white; border: 1px solid #ccc; padding: 8px; margin-bottom: 8px; font-family: monospace; font-size: 12px; border-radius: 4px; overflow-x: auto; white-space: pre-wrap; word-break: break-all; min-height: 20px; max-height: 60px; flex-shrink: 0; }
      .highlight { background-color: #fce8b2; font-weight: bold; padding: 0 2px; border-radius: 2px; }
      #table-wrap { flex: 1; overflow-y: auto; min-height: 0; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
      table { width: 100%; border-collapse: collapse; background: white; }
      td { padding: 6px 8px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 12px; }
      td:first-child { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 0; width: 70%; }
      td.val { text-align: right; color: #0d652d; font-family: monospace; white-space: nowrap; width: 30%; }
      tr.selected { background-color: #e8f0fe; font-weight: bold; border-left: 4px solid #1a73e8; }
      .cell-formula { font-size: 10px; color: #666; font-family: monospace; padding: 2px 8px 4px; border-bottom: 1px solid #eee; display: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      tr.selected + tr.formula-row .cell-formula { display: block; }
      .instructions { font-size: 9px; color: #888; margin-top: 6px; text-align: center; flex-shrink: 0; }
      #loading-overlay { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(241,243,244,0.7); z-index: 10; justify-content: center; align-items: center; }
      #loading-overlay.active { display: flex; }
      .spinner { width: 24px; height: 24px; border: 3px solid #ddd; border-top-color: #1a73e8; border-radius: 50%; animation: spin 0.6s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      #focus-prompt { display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(241,243,244,0.5); z-index: 5; justify-content: center; align-items: center; cursor: pointer; }
      #focus-prompt.active { display: flex; }
      #focus-prompt span { background: white; padding: 8px 16px; border-radius: 6px; font-size: 12px; color: #555; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
    </style>
  </head>
  <body tabindex="-1">
    <div id="loading-overlay" class="active"><div class="spinner"></div></div>
    <div id="focus-prompt"><span>Click here to enable keyboard navigation</span></div>
    <div id="mode-indicator">MODE: LOADING...</div>
    <div id="formula-box">Initializing...</div>
    <div id="table-wrap"><table id="prec-table"><tbody id="prec-body"></tbody></table></div>
    <div class="instructions">&uarr;&darr; Navigate | &rarr; Trace Deep | &larr; Step Back<br>Enter to Finish | Esc to Cancel</div>

    <script>
      let traceData = null;
      let selectedIndex = 0;
      let historyStack = [];
      const overlay = document.getElementById('loading-overlay');
      const focusPrompt = document.getElementById('focus-prompt');
      let activated = false;

      function showLoading() { overlay.classList.add('active'); }
      function hideLoading() { overlay.classList.remove('active'); }

      focusPrompt.addEventListener('click', function() {
        focusPrompt.classList.remove('active');
        activated = true;
      });

      window.onload = function() {
        google.script.run.withSuccessHandler(renderUI).getTraceData();
      };

      function renderUI(data) {
        hideLoading();
        document.body.focus();
        activated = true;
        if (data.error) {
          document.getElementById('formula-box').innerText = data.error;
          document.getElementById('mode-indicator').innerText = "ERROR";
          return;
        }
        traceData = data;
        document.getElementById('mode-indicator').innerText = "MODE: " + data.mode;
        document.getElementById('formula-box').innerText = data.formula;
        
        const tbody = document.getElementById('prec-body');
        tbody.innerHTML = "";
        
        data.precedents.forEach((prec, i) => {
          let tr = document.createElement('tr');
          tr.id = 'row-' + i;

          let tdRef = document.createElement('td');
          tdRef.textContent = prec.shortRef;

          let tdVal = document.createElement('td');
          tdVal.className = 'val';
          tdVal.textContent = prec.value;

          tr.appendChild(tdRef);
          tr.appendChild(tdVal);
          tr.onclick = () => selectRow(i);
          tbody.appendChild(tr);

          // Formula subtitle row (visible only when selected)
          if (prec.cellFormula) {
            let fRow = document.createElement('tr');
            fRow.className = 'formula-row';
            let fTd = document.createElement('td');
            fTd.colSpan = 2;
            fTd.className = 'cell-formula';
            fTd.textContent = prec.cellFormula;
            fTd.title = prec.cellFormula;
            fRow.appendChild(fTd);
            tbody.appendChild(fRow);
          }
        });
        selectRow(0);
      }

      function selectRow(index) {
        const prevRow = document.getElementById('row-' + selectedIndex);
        if (prevRow) prevRow.classList.remove('selected');
        selectedIndex = index;
        const currentRow = document.getElementById('row-' + selectedIndex);
        if (currentRow) { currentRow.classList.add('selected'); currentRow.scrollIntoView({ block: 'nearest' }); }
        
        const target = traceData.precedents[selectedIndex];
        if (selectedIndex !== 0 && traceData.mode === 'Precedents') {
          highlightInBox(target.shortRef);
        } else {
          document.getElementById('formula-box').innerText = traceData.formula;
        }
        google.script.run.goToPrecedent({ "targetA1": target.fullRef });
      }

      function highlightInBox(ref) {
        const formula = traceData.formula;
        const escaped = ref.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        const regex = new RegExp("(" + escaped + ")", "gi");
        document.getElementById('formula-box').innerHTML = formula.replace(regex, '<span class="highlight">$1</span>');
      }

      function goBack() {
        if (historyStack.length > 0) {
          showLoading();
          const lastRef = historyStack.pop();
          google.script.run.withSuccessHandler(renderUI).getDeepTraceData(lastRef);
        } else {
          selectRow(0);
        }
      }

      function goDeep() {
        showLoading();
        const currentHome = traceData.precedents[0].fullRef;
        historyStack.push(currentHome);
        const target = traceData.precedents[selectedIndex].fullRef;
        google.script.run.withSuccessHandler(renderUI).getDeepTraceData(target);
      }

      document.addEventListener('keydown', function(e) {
        if (!traceData) return;
        if (e.key === 'ArrowDown' && selectedIndex < traceData.precedents.length - 1) {
          e.preventDefault(); selectRow(selectedIndex + 1);
        } else if (e.key === 'ArrowUp' && selectedIndex > 0) {
          e.preventDefault(); selectRow(selectedIndex - 1);
        } else if (e.key === 'ArrowRight' && selectedIndex !== 0) {
          e.preventDefault(); goDeep();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault(); goBack();
        } else if (e.key === 'Enter' || e.key === 'Escape') {
          google.script.host.close();
        }
      });
    </script>
  </body>
</html>